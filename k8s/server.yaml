---
kind: Service
apiVersion: v1
metadata:
  name: schlep
  namespace: schlep
  labels:
    app: schlep
    role: server
  # annotations:
  #   balancer.linkerd.io/failure-accrual: "consecutive"
  #   balancer.linkerd.io/failure-accrual-consecutive-max-failures: "3"
spec:
  type: LoadBalancer
  selector:
    app: schlep
    role: server
  ports:
    - name: http
      appProtocol: kubernetes.io/h2c
      protocol: TCP
      port: 80
      targetPort: 8080
    - name: grpc
      appProtocol: kubernetes.io/h2c
      protocol: TCP
      port: 8080
      targetPort: 8080
...
---
kind: ConfigMap
apiVersion: v1
metadata:
  name: server
  namespace: schlep
  labels:
    app: schlep
data:
  good.json: |
    {
      "sleep-p50": 0.01,
      "sleep-p90": 0.1,
      "sleep-p99": 0.3,
      "data-p50": 1000,
      "data-p90": 100000,
      "data-p99": 1000000,
    }
  fail.json: |
    {
      "fail-rate": 0.1,
      "data-p50": 1000,
      "data-p90": 100000,
      "data-p99": 1000000,
    }
  slow.json: |
    {
      "data-p50": 1000,
      "data-p90": 100000,
      "data-p99": 1000000,
      "sleep-p50": 0.1,
      "sleep-p90": 0.3,
      "sleep-p99": 1.0,
    }
...
---
kind: Deployment
apiVersion: apps/v1
metadata:
  name: server-good
  namespace: schlep
  labels:
    app: schlep
    role: server
    flavor: good
spec:
  replicas: 1
  selector:
    matchLabels:
      app: schlep
      role: server
      flavor: good
  template:
    metadata:
      labels:
        app: schlep
        role: server
        flavor: good
    spec:
      containers:
        - name: main
          image: ghcr.io/olix0r/schlep:v0.4.0
          args:
            - server
            - --config=/good.json
          ports:
            - containerPort: 8080
          volumeMounts:
            - name: config
              mountPath: /good.json
              subPath: good.json
      volumes:
        - name: config
          configMap:
            name: server
            items:
              - key: good.json
                path: good.json
...
---
kind: Deployment
apiVersion: apps/v1
metadata:
  name: server-fail
  namespace: schlep
  labels:
    app: schlep
    role: server
    flavor: fail
spec:
  replicas: 1
  selector:
    matchLabels:
      app: schlep
      role: server
      flavor: fail
  template:
    metadata:
      labels:
        app: schlep
        role: server
        flavor: fail
    spec:
      containers:
        - name: main
          image: ghcr.io/olix0r/schlep:v0.4.0
          args:
            - server
            - --config=/fail.json
          ports:
            - containerPort: 8080
          volumeMounts:
            - name: config
              mountPath: /fail.json
              subPath: fail.json
      volumes:
        - name: config
          configMap:
            name: server
            items:
              - key: fail.json
                path: fail.json
...
---
kind: Deployment
apiVersion: apps/v1
metadata:
  name: server-slow
  namespace: schlep
  labels:
    app: schlep
    role: server
    flavor: slow
spec:
  replicas: 1
  selector:
    matchLabels:
      app: schlep
      role: server
      flavor: slow
  template:
    metadata:
      labels:
        app: schlep
        role: server
        flavor: slow
    spec:
      containers:
        - name: main
          image: ghcr.io/olix0r/schlep:v0.4.0
          args:
            - server
            - --config=/slow.json
          ports:
            - containerPort: 8080
          volumeMounts:
            - name: config
              mountPath: /slow.json
              subPath: slow.json
      volumes:
        - name: config
          configMap:
            name: server
            items:
              - key: slow.json
                path: slow.json
